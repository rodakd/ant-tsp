var D=Object.defineProperty;var tt=(B,b,C)=>b in B?D(B,b,{enumerable:!0,configurable:!0,writable:!0,value:C}):B[b]=C;var m=(B,b,C)=>(tt(B,typeof b!="symbol"?b+"":b,C),C);(function(){"use strict";const C=(s,t)=>{const e=s[0],n=t[0],h=s[1],T=t[1],S=6371e3,N=h*Math.PI/180,Y=T*Math.PI/180,G=(T-h)*Math.PI/180,I=(n-e)*Math.PI/180,M=Math.sin(G/2)*Math.sin(G/2)+Math.cos(N)*Math.cos(Y)*Math.sin(I/2)*Math.sin(I/2),k=2*Math.atan2(Math.sqrt(M),Math.sqrt(1-M));return S*k/1e3},U=(s,t)=>{let e=0;for(let n=0;n<t.length-1;n++){const h=t[n],T=t[n+1];e+=s[h][T]}return e+=s[t[t.length-1]][t[0]],e},K=s=>{const t=[];for(let e=0;e<s.length;e++){t[e]=[];for(let n=0;n<s.length;n++)t[e][n]=C(s[e],s[n])}return t},O=s=>{const t=[];for(let e=0;e<s;e++)t.push(e);return V(t)},R=(s,t)=>{const e=[];return s.forEach(n=>{e.push(t[n])}),e.push(t[s[0]]),e},z=s=>{const t=s.length,e=new Array(t).fill(-1);for(let n=0;n<t;n++)e[s[n]]=s[(n+1)%t];return e},Q=s=>{const t=s.length,e=new Array(t).fill(-1);let n=0;for(let h=0;h<t;h++)e[h]=n,n=s[n];return e},V=s=>{let t=s.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[s[t],s[e]]=[s[e],s[t]];return s},X=s=>{const t=[];for(let e=0;e<s.length;e++){const n=s[e];let h=!0;for(let T=e+1;T<s.length;T++){const S=s[T];if(n[0]===S[0]&&n[1]===S[1]){h=!1;break}}h&&t.push(n)}return t.forEach(e=>{e[0]=Number(e[0].toFixed(6)),e[1]=Number(e[1].toFixed(6))}),t};function E(s){postMessage(s)}const Z=s=>{let t=new W;onmessage=async e=>{var h;if(!((h=e==null?void 0:e.data)!=null&&h.type))return;const n=e.data;switch(n.type){case"run":t=new W,t.params=n.params,t.markers=X(n.markers),t.speedPercent=n.speedPercent,t.iterationsLimit=n.iterationsLimit,t.performanceMode=n.performanceMode,s(t).catch(T=>{if(T!=="Stopped")throw T});break;case"stop":t.running=!1;break;case"pause":t.paused=!0;break;case"resume":t.paused=!1;break;case"changeSpeed":t.speedPercent=n.speedPercent}}};class W{constructor(){m(this,"bestTour",[]);m(this,"params",{});m(this,"markers",[]);m(this,"iteration",0);m(this,"paused",!1);m(this,"running",!0);m(this,"cost",1/0);m(this,"performanceMode",!1);m(this,"speedPercent",60);m(this,"iterationsLimit",null);m(this,"bestToursHistory",[]);m(this,"lastGetBestTour",null);m(this,"helpers",{matrixCost(t,e){return U(t,e)},tourToSuccessors(t){return z(t)},successorsToTour(t){return Q(t)}})}getInput(){const t=K(this.markers),e=O(this.markers.length),n=U(t,e),h=this.markers.length,T=this.params;return this.updateBestTour(()=>e,n),{d:t,tour:e,cost:n,n:h,params:T}}async updateBestTour(t,e){if(e>=this.cost)return;this.cost=e;const n={cost:e,iteration:this.iteration};if(this.bestToursHistory.push(n),this.performanceMode){this.lastGetBestTour=t;return}this.bestTour=R(t(),this.markers),E({type:"updateBestTour",bestTour:this.bestTour,bestToursHistory:this.bestToursHistory,cost:this.cost}),await this.sleep()}async updateTrail(t){if(this.performanceMode)return;const e=R(t(),this.markers);E({type:"updateTrail",trail:e}),await this.sleep()}incrementIteration(){if(this.iteration++,this.iterationsLimit&&this.iteration>this.iterationsLimit)return this.iteration--,this.end();this.performanceMode||E({type:"updateIteration",iteration:this.iteration})}async updateCurrentTour(t){if(this.performanceMode)return;const e=R(t(),this.markers);E({type:"updateCurrentTour",currentTour:e}),await this.sleep()}async sleep(){if(!this.running)throw"Stopped";if(this.performanceMode)return;for(;this.paused&&this.running;)await new Promise(e=>setTimeout(e,200));const t=500-this.speedPercent/100*500+50;return new Promise(e=>setTimeout(e,t))}log(t){E({type:"log",toLog:JSON.stringify(t)})}error(t){E({type:"error",text:t})}end(){let t=this.bestTour;throw this.lastGetBestTour&&(t=R(this.lastGetBestTour(),this.markers)),E({type:"end",cost:this.cost,bestTour:t,iterations:this.iteration,bestToursHistory:this.bestToursHistory}),this.running=!1,"Stopped"}}async function $(s){function t(o,r){const l=r[0].length;for(let a=0;a<l;a++)for(let c=0;c<l;c++)r[a][c]=o;for(let a=0;a<l;a++)r[a][a]=0;return r}function e(o,r){return o=Math.ceil(o),r=Math.floor(r),Math.floor(Math.random()*(r-o+1)+o)}function n(o,r,l,a,c){if(o==r)l+=1,c=t(l,c);else for(let p=0;p<o.length;p++){const P=c[0].length;c[o[p]][o[(p+1)%P]]+=l,c[r[p]][r[(p+1)%P]]+=a}return[c,l]}function h(o,r,l){const a=r.length;for(let c=1;c<a-1;c++){let p=0;for(let w=c+1;w<a;w++)p+=l[r[c-1]][r[w]];const P=e(0,p-1);let f=c;for(p=l[r[c-1]][r[f]];p<P;)p+=l[r[c-1]][r[f+1]],f+=1;const H=r[f];r[f]=r[c],r[c]=H}return[r,s.helpers.matrixCost(o,r)]}async function T(o,r,l){let a=s.helpers.tourToSuccessors(r);const c=[];for(let i=0;i<I;i++){c[i]=[];for(let d=0;d<I;d++)c[i][d]=0}let p=0,P=0,f=0,H=!0,w=null;function J(i,d,A,x,u,_){for(i[_]=u;A!=x;){const y=A,g=i[d],v=d;i[d]=y,A=v,d=g}}for(;f!=P||H;){H=!1,p+=1;let i=a[f],d=l-o[f][i],A=!0;for(;A;){A=!1;let x=l,u=a[i],_=u;for(;a[u]!=f;){s.incrementIteration();const y=a[u];if(d-o[u][y]+o[u][f]+o[i][y]<l){_=u,x=d-o[u][y]+o[u][f]+o[i][y];break}c[u][y]!=p&&d+o[i][y]<x&&(x=d+o[i][y],_=u),u=y,await s.updateCurrentTour(()=>{const g=a.slice();return J(g,g[i],i,u,g[u],i),s.helpers.successorsToTour(g)})}if(Number(x.toFixed(7))<Number(l.toFixed(7))){A=!0,u=_,w=a[_],c[u][w]=c[w][u]=p,d+=o[i][w]-o[u][w];const y=i,g=a[i];J(a,g,y,u,w,i),i=u,d+o[f][i]<l&&(l=d+o[f][i],a[f]=i,P=i,H=!0,r=s.helpers.successorsToTour(a),await s.updateTrail(()=>r))}}a=s.helpers.tourToSuccessors(r),f=a[f]}return[r,l]}const S=s.getInput(),{d:N,params:{exploitation:Y,loops:G}}=S,I=N[0].length;let M=S.tour,k=S.cost,L=1,F=0,q=M.slice(),j=t(L,new Array(I).fill(new Array(I).fill(-1)));for(let o=0;o<G;o++)[M,F]=h(N,M,j),await s.updateTrail(()=>M),[M,F]=await T(N,M,F),Number(F.toFixed(7))<Number(k.toFixed(7))?(k=F,q=M.slice(),L=1,j=t(L,j),await s.updateBestTour(()=>q,k)):[j,L]=n(M,q,L,Y,j);s.end()}Z($)})();
