var _=Object.defineProperty;var C=(f,l,p)=>l in f?_(f,l,{enumerable:!0,configurable:!0,writable:!0,value:p}):f[l]=p;var c=(f,l,p)=>(C(f,typeof l!="symbol"?l+"":l,p),p);(function(){"use strict";const p=(s,t)=>{const e=s[0],r=t[0],o=s[1],n=t[1],h=6371e3,T=o*Math.PI/180,M=n*Math.PI/180,u=(n-o)*Math.PI/180,a=(r-e)*Math.PI/180,i=Math.sin(u/2)*Math.sin(u/2)+Math.cos(T)*Math.cos(M)*Math.sin(a/2)*Math.sin(a/2),m=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return h*m/1e3},g=(s,t)=>{let e=0;for(let r=0;r<t.length-1;r++){const o=t[r],n=t[r+1];e+=s[o][n]}return e+=s[t[t.length-1]][t[0]],e},P=s=>{const t=[];for(let e=0;e<s.length;e++){t[e]=[];for(let r=0;r<s.length;r++)t[e][r]=p(s[e],s[r])}return t},S=s=>{const t=[];for(let e=0;e<s;e++)t.push(e);return B(t)},y=(s,t)=>{const e=[];return s.forEach(r=>{e.push(t[r])}),e.push(t[s[0]]),e},U=s=>{const t=s.length,e=new Array(t).fill(-1);for(let r=0;r<t;r++)e[s[r]]=s[(r+1)%t];return e},A=s=>{const t=s.length,e=new Array(t).fill(-1);let r=0;for(let o=0;o<t;o++)e[o]=r,r=s[r];return e},B=s=>{let t=s.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[s[t],s[e]]=[s[e],s[t]];return s},D=s=>{const t=[];for(let e=0;e<s.length;e++){const r=s[e];let o=!0;for(let n=e+1;n<s.length;n++){const h=s[n];if(r[0]===h[0]&&r[1]===h[1]){o=!1;break}}o&&t.push(r)}return t.forEach(e=>{e[0]=Number(e[0].toFixed(6)),e[1]=Number(e[1].toFixed(6))}),t};function d(s){postMessage(s)}const L=s=>{let t=new I;onmessage=async e=>{var o;if(!((o=e==null?void 0:e.data)!=null&&o.type))return;const r=e.data;switch(r.type){case"run":t=new I,t.params=r.params,t.markers=D(r.markers),t.speedPercent=r.speedPercent,t.iterationsLimit=r.iterationsLimit,t.performanceMode=r.performanceMode,s(t).catch(n=>{if(n!=="Stopped")throw n});break;case"stop":t.running=!1;break;case"pause":t.paused=!0;break;case"resume":t.paused=!1;break;case"changeSpeed":t.speedPercent=r.speedPercent}}};class I{constructor(){c(this,"bestTour",[]);c(this,"params",{});c(this,"markers",[]);c(this,"iteration",0);c(this,"paused",!1);c(this,"running",!0);c(this,"cost",1/0);c(this,"performanceMode",!1);c(this,"speedPercent",60);c(this,"iterationsLimit",null);c(this,"bestToursHistory",[]);c(this,"lastGetBestTour",null);c(this,"lastTourUpdate",0);c(this,"lastIterationUpdate",0);c(this,"helpers",{matrixCost(t,e){return g(t,e)},tourToSuccessors(t){return U(t)},successorsToTour(t){return A(t)}})}getInput(){const t=P(this.markers),e=S(this.markers.length),r=g(t,e),o=this.markers.length,n=this.params;return this.updateBestTour(()=>e,r),{d:t,tour:e,cost:r,n:o,params:n}}async updateBestTour(t,e){if(e>=this.cost)return;this.cost=e;const r={cost:e,iteration:this.iteration};if(this.bestToursHistory.push(r),!this.shouldUpdateTour()){this.lastGetBestTour=t;return}this.bestTour=y(t(),this.markers),d({type:"updateBestTour",bestTour:this.bestTour,bestToursHistory:this.bestToursHistory,cost:this.cost}),await this.sleep()}async updateTrail(t){if(this.performanceMode)return;const e=y(t(),this.markers);d({type:"updateTrail",trail:e}),await this.sleep()}incrementIteration(){if(this.iteration++,this.iterationsLimit&&this.iteration>this.iterationsLimit)return this.iteration--,this.end();this.shouldUpdateIteration()&&d({type:"updateIteration",iteration:this.iteration})}async updateCurrentTour(t){if(this.performanceMode)return;const e=y(t(),this.markers);d({type:"updateCurrentTour",currentTour:e}),await this.sleep()}async sleep(){if(!this.running)throw"Stopped";if(this.performanceMode)return;for(;this.paused&&this.running;)await new Promise(e=>setTimeout(e,200));const t=500-this.speedPercent/100*500+50;return new Promise(e=>setTimeout(e,t))}log(t){d({type:"log",toLog:JSON.stringify(t)})}error(t){d({type:"error",text:t})}end(){let t=this.bestTour;throw this.lastGetBestTour&&(t=y(this.lastGetBestTour(),this.markers)),d({type:"end",cost:this.cost,bestTour:t,iterations:this.iteration,bestToursHistory:this.bestToursHistory}),this.running=!1,"Stopped"}shouldUpdateTour(){if(!this.performanceMode)return!0;const t=Date.now();return t-this.lastTourUpdate>3e3?(this.lastTourUpdate=t,!0):!1}shouldUpdateIteration(){if(!this.performanceMode)return!0;const t=Date.now();return t-this.lastIterationUpdate>3e3?(this.lastIterationUpdate=t,!0):!1}}async function x(s){const{d:t,tour:e,cost:r}=s.getInput(),o=s.helpers.tourToSuccessors(e);let n=0,h=o[0],T=o[o[0]],M=r,u=n,a=h,i=T,m,w;for(;s.incrementIteration(),m=t[u][o[a]]+t[a][o[i]]+t[i][o[u]]-t[u][o[u]]-t[a][o[a]]-t[i][o[i]],await s.updateCurrentTour(()=>{const E=o.slice();return b(E,u,a,i),s.helpers.successorsToTour(E)}),m<0&&(M+=m,b(o,u,a,i),w=a,a=i,i=w,n=u,h=a,T=i,await s.updateBestTour(()=>s.helpers.successorsToTour(o),M)),i=o[i],i===u&&(a=o[a],i=o[a]),i===u&&(u=o[u],a=o[u],i=o[a]),!(u===n&&a===h&&i===T););s.end()}function b(s,t,e,r){const o=s[t],n=s[e],h=s[r];s[t]=n,s[e]=h,s[r]=o}L(x)})();
