var D=Object.defineProperty;var k=(p,u,h)=>u in p?D(p,u,{enumerable:!0,configurable:!0,writable:!0,value:h}):p[u]=h;var a=(p,u,h)=>(k(p,typeof u!="symbol"?u+"":u,h),h);(function(){"use strict";const h=(s,t)=>{const e=s[0],n=t[0],r=s[1],o=t[1],c=6371e3,y=r*Math.PI/180,i=o*Math.PI/180,f=(o-r)*Math.PI/180,d=(n-e)*Math.PI/180,T=Math.sin(f/2)*Math.sin(f/2)+Math.cos(y)*Math.cos(i)*Math.sin(d/2)*Math.sin(d/2),M=2*Math.atan2(Math.sqrt(T),Math.sqrt(1-T));return c*M/1e3},g=(s,t)=>{let e=0;for(let n=0;n<t.length-1;n++){const r=t[n],o=t[n+1];e+=s[r][o]}return e+=s[t[t.length-1]][t[0]],e},P=s=>{const t=[];for(let e=0;e<s.length;e++){t[e]=[];for(let n=0;n<s.length;n++)t[e][n]=h(s[e],s[n])}return t},B=s=>{const t=[];for(let e=0;e<s;e++)t.push(e);return I(t)},m=(s,t)=>{const e=[];return s.forEach(n=>{e.push(t[n])}),e.push(t[s[0]]),e},C=s=>{const t=s.length,e=new Array(t).fill(-1);for(let n=0;n<t;n++)e[s[n]]=s[(n+1)%t];return e},S=s=>{const t=s.length,e=new Array(t).fill(-1);let n=0;for(let r=0;r<t;r++)e[r]=n,n=s[n];return e},I=s=>{let t=s.length,e;for(;t!=0;)e=Math.floor(Math.random()*t),t--,[s[t],s[e]]=[s[e],s[t]];return s},A=s=>{const t=[];for(let e=0;e<s.length;e++){const n=s[e];let r=!0;for(let o=e+1;o<s.length;o++){const c=s[o];if(n[0]===c[0]&&n[1]===c[1]){r=!1;break}}r&&t.push(n)}return t.forEach(e=>{e[0]=Number(e[0].toFixed(6)),e[1]=Number(e[1].toFixed(6))}),t};function l(s){postMessage(s)}const L=s=>{let t=new w;onmessage=async e=>{var r;if(!((r=e==null?void 0:e.data)!=null&&r.type))return;const n=e.data;switch(n.type){case"run":t=new w,t.params=n.params,t.markers=A(n.markers),t.speedPercent=n.speedPercent,t.iterationsLimit=n.iterationsLimit,t.performanceMode=n.performanceMode,s(t).catch(o=>{if(o!=="Stopped")throw o});break;case"stop":t.running=!1;break;case"pause":t.paused=!0;break;case"resume":t.paused=!1;break;case"changeSpeed":t.speedPercent=n.speedPercent}}};class w{constructor(){a(this,"bestTour",[]);a(this,"params",{});a(this,"markers",[]);a(this,"iteration",0);a(this,"paused",!1);a(this,"running",!0);a(this,"cost",1/0);a(this,"performanceMode",!1);a(this,"speedPercent",60);a(this,"iterationsLimit",null);a(this,"bestToursHistory",[]);a(this,"lastGetBestTour",null);a(this,"helpers",{matrixCost(t,e){return g(t,e)},tourToSuccessors(t){return C(t)},successorsToTour(t){return S(t)}})}getInput(){const t=P(this.markers),e=B(this.markers.length),n=g(t,e),r=this.markers.length,o=this.params;return this.updateBestTour(()=>e,n),{d:t,tour:e,cost:n,n:r,params:o}}async updateBestTour(t,e){if(e>=this.cost)return;this.cost=e;const n={cost:e,iteration:this.iteration};if(this.bestToursHistory.push(n),this.performanceMode){this.lastGetBestTour=t;return}this.bestTour=m(t(),this.markers),l({type:"updateBestTour",bestTour:this.bestTour,bestToursHistory:this.bestToursHistory,cost:this.cost}),await this.sleep()}async updateTrail(t){if(this.performanceMode)return;const e=m(t(),this.markers);l({type:"updateTrail",trail:e}),await this.sleep()}incrementIteration(){if(this.iteration++,this.iterationsLimit&&this.iteration>this.iterationsLimit)return this.iteration--,this.end();this.performanceMode||l({type:"updateIteration",iteration:this.iteration})}async updateCurrentTour(t){if(this.performanceMode)return;const e=m(t(),this.markers);l({type:"updateCurrentTour",currentTour:e}),await this.sleep()}async sleep(){if(!this.running)throw"Stopped";if(this.performanceMode)return;for(;this.paused&&this.running;)await new Promise(e=>setTimeout(e,200));const t=500-this.speedPercent/100*500+50;return new Promise(e=>setTimeout(e,t))}log(t){l({type:"log",toLog:JSON.stringify(t)})}error(t){l({type:"error",text:t})}end(){let t=this.bestTour;throw this.lastGetBestTour&&(t=m(this.lastGetBestTour(),this.markers)),l({type:"end",cost:this.cost,bestTour:t,iterations:this.iteration,bestToursHistory:this.bestToursHistory}),this.running=!1,"Stopped"}}async function x(s){const{d:t,tour:e,cost:n}=s.getInput(),r=_(e);let o=0,c=0,y=n,i,f,d,T;for(;r[r[o]]>>1!==c;){for(i=r[r[o]];i>>1!==c&&(r[i]>>1!==c||o>>1!==c);)s.incrementIteration(),await s.updateCurrentTour(()=>{const M=r.slice();return E(M,o,i,r[o],r[i]),b(M)}),f=t[o>>1][i>>1]+t[r[o]>>1][r[i]>>1]-t[o>>1][r[o]>>1]-t[i>>1][r[i]>>1],f<0&&(d=r[o],T=r[i],y+=f,c=o>>1,E(r,o,i,d,T),await s.updateBestTour(()=>b(r),y)),i=r[i];o=r[o]}s.end()}function _(s){const t=s.length,e=new Array(2*t).fill(-1);for(let n=0;n<t-1;n++)e[2*s[n]]=2*s[n+1];e[2*s[t-1]]=2*s[0];for(let n=1;n<t;n++)e[2*s[n]+1]=2*s[n-1]+1;return e[2*s[0]+1]=2*s[t-1]+1,e}function b(s){const t=Math.ceil(s.length/2),e=new Array(t).fill(-1);let n=0;for(let r=0;r<t;r++)e[r]=n>>1,n=s[n];return e}function E(s,t,e,n,r){s[t]=e^1,s[e]=t^1,s[n^1]=r,s[r^1]=n}L(x)})();
